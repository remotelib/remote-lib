<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/remote-protocol/src/Session.js | Remotelib</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Run code remotely"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Remotelib"><meta property="twitter:description" content="Run code remotely"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/remotelib/remote-lib"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#reference-context-src">reference-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/reference-context/src/reference-context.js~ReferenceContext.html">ReferenceContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isValidReference">isValidReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Reference">Reference</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src">remote-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/AssignableContext.js~AssignableContext.html">AssignableContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/Context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/EnvContext.js~EnvContext.html">EnvContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalContext.js~LocalContext.html">LocalContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalPromise.js~LocalPromise.html">LocalPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalReference.js~LocalReference.html">LocalReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/ObjectSnapshot.js~ObjectSnapshot.html">ObjectSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteContext.js~RemoteContext.html">RemoteContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemotePromise.js~RemotePromise.html">RemotePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteSession.js~RemoteSession.html">RemoteSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteValue.js~RemoteValue.html">RemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getInstance">getInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isRemoteValue">isRemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-observe">observe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-reveal">reveal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-revoke">revoke</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src-actions">remote-context/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/DeleteAction.js~DeleteAction.html">DeleteAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/GetAction.js~GetAction.html">GetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDefinePropertyAction.js~LocalDefinePropertyAction.html">LocalDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDeletePropertyAction.js~LocalDeletePropertyAction.html">LocalDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalPreventExtensionsAction.js~LocalPreventExtensionsAction.html">LocalPreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalReferenceAction.js~LocalReferenceAction.html">LocalReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalSetPrototypeOfAction.js~LocalSetPrototypeOfAction.html">LocalSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/PropertyDescriptorAction.js~PropertyDescriptorAction.html">PropertyDescriptorAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/PropertyDescriptorsAction.js~PropertyDescriptorsAction.html">PropertyDescriptorsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferenceAction.js~ReferenceAction.html">ReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferencePropertyAction.js~ReferencePropertyAction.html">ReferencePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectAction.js~ReflectAction.html">ReflectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectApplyAction.js~ReflectApplyAction.html">ReflectApplyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectConstructAction.js~ReflectConstructAction.html">ReflectConstructAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectGetAction.js~ReflectGetAction.html">ReflectGetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectPromiseAction.js~ReflectPromiseAction.html">ReflectPromiseAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDefinePropertyAction.js~RemoteDefinePropertyAction.html">RemoteDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDeletePropertyAction.js~RemoteDeletePropertyAction.html">RemoteDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemotePreventExtensionsAction.js~RemotePreventExtensionsAction.html">RemotePreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteReferenceAction.js~RemoteReferenceAction.html">RemoteReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetAction.js~RemoteSetAction.html">RemoteSetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetFunctionAction.js~RemoteSetFunctionAction.html">RemoteSetFunctionAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetObjectAction.js~RemoteSetObjectAction.html">RemoteSetObjectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetPrototypeOfAction.js~RemoteSetPrototypeOfAction.html">RemoteSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetSymbolAction.js~RemoteSetSymbolAction.html">RemoteSetSymbolAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/UndefinedValueAction.js~UndefinedValueAction.html">UndefinedValueAction</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-instance-src">remote-instance/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-instance/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-lib-src">remote-lib/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/Context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/Library.js~Library.html">Library</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src">remote-protocol/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src-actions">remote-protocol/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/Action.js~Action.html">Action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/RequestAction.js~RequestAction.html">RequestAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/ResponseAction.js~ResponseAction.html">ResponseAction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/remote-protocol/src/Session.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Copyright 2017 Moshe Simantov
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import EventEmitter from &apos;events&apos;;
import { randomBytes } from &apos;crypto&apos;;
import { Action, RequestAction } from &apos;./actions&apos;;

const kStream = Symbol(&apos;stream&apos;);
const kRequestTimeout = Symbol(&apos;requestTimeout&apos;);
const kNextReqId = Symbol(&apos;nextReqId&apos;);
const kRequestsMap = Symbol(&apos;requestsMap&apos;);
const kRequestsTimer = Symbol(&apos;requestsTimer&apos;);
const kEndTimeout = Symbol(&apos;endedTimeout&apos;);
const kEndTimer = Symbol(&apos;isEnded&apos;);

// Default timeout for request
const REQUEST_DEFAULT_TIMEOUT = 20e3; // 20 seconds

// How often check for timeout requests
const REQUEST_TIMEOUT_INTERVAL = 100; // 100ms

// If there are open requests, how much time to wait before closing the connection
const SESSION_END_DEFAULT_TIMEOUT = 200; // 200 milliseconds

const REQUEST_ID_BYTES = 4;
const MAX_OPEN_REQUESTS = 256 ** REQUEST_ID_BYTES;

function generateRequestId() {
  return randomBytes(REQUEST_ID_BYTES).readUIntBE(0, REQUEST_ID_BYTES);
}

/**
 * @example
 * import { Session } from &apos;remote-protocol&apos;;
 *
 * const session = new Session(objectStream);
 */
export default class Session extends EventEmitter {
  /**
   * Create a new session with an object-stream to the other peer.
   *
   * @param {Stream} objectStream An object duplex stream
   * @param {object} [opts] Options
   * @param {null|number} [opts.timeout=20e3] Default timeout for requests in milliseconds. If
   * null is given, request will not timeout.
   * @param {null|number} [opts.endTimeout=200] Default timeout to end the session in
   * milliseconds after the other ended the stream.
   */
  constructor(objectStream, opts = {}) {
    if (
      typeof objectStream !== &apos;object&apos; ||
      typeof objectStream.on !== &apos;function&apos; ||
      typeof objectStream.write !== &apos;function&apos;
    ) {
      throw new TypeError(`Invalid stream argument: ${objectStream}`);
    }

    super();

    // for promises that listen for close event
    this.setMaxListeners(0);

    const { timeout, endTimeout } = opts;
    if (timeout !== undefined) {
      if (timeout !== null &amp;&amp; typeof timeout !== &apos;number&apos;) {
        throw new TypeError(`Invalid &quot;timeout&quot; option: ${timeout}`);
      }

      /**
       * @type {null|number}
       * @private
       */
      this[kRequestTimeout] = timeout;
    } else {
      this[kRequestTimeout] = REQUEST_DEFAULT_TIMEOUT;
    }

    if (endTimeout !== undefined) {
      if (typeof endTimeout !== &apos;number&apos;) {
        throw new TypeError(`Invalid &quot;endTimeout&quot; option: ${endTimeout}`);
      }

      /**
       * @type {null|number}
       * @private
       */
      this[kEndTimeout] = endTimeout;
    } else {
      this[kEndTimeout] = SESSION_END_DEFAULT_TIMEOUT;
    }

    /**
     * @type {Stream}
     * @private
     */
    this[kStream] = objectStream;

    /**
     * @type {number}
     * @private
     */
    this[kNextReqId] = generateRequestId();

    /**
     * @type {Map}
     * @private
     */
    this[kRequestsMap] = new Map();

    /**
     * @type {null|TimeoutID}
     * @private
     */
    this[kRequestsTimer] = null;

    this[kStream].on(&apos;data&apos;, action =&gt; {
      if (!(action instanceof Action)) {
        this.destroy(
          new TypeError(`Unrecognized action received: ${typeof action}`),
        );
        return;
      }

      try {
        Promise.resolve(action.exec(this)).catch(err =&gt; {
          if (!this[kStream]) return;

          this.destroy(err);
        });
      } catch (err) {
        this.destroy(err);
      }
    });

    this[kStream].on(&apos;end&apos;, () =&gt; {
      if (!this[kStream]) return;

      const requests = this[kRequestsMap];
      this[kRequestsMap] = null;

      requests.forEach(({ onRejected }) =&gt; {
        onRejected(new Error(&apos;Session ended before request completed&apos;));
      });

      this.emit(&apos;end&apos;);

      if (this.isEnded) {
        this[kStream] = null;
        this.destroy();
        return;
      }

      if (this[kEndTimeout]) {
        /**
         * @type {TimeoutID}
         * @private
         */
        this[kEndTimer] = setTimeout(() =&gt; {
          this[kEndTimer] = true;
          this.destroy();
        }, this[kEndTimeout]);
      }
    });

    this[kStream].on(&apos;finish&apos;, () =&gt; {
      if (!this[kStream]) return;

      this.emit(&apos;finish&apos;);

      if (!this[kRequestsMap]) {
        this[kStream] = null;
        this.destroy();
      }
    });

    this[kStream].on(&apos;close&apos;, () =&gt; {
      if (!this[kStream]) return;

      this[kStream] = null;
      this.destroy();
    });

    this[kStream].on(&apos;error&apos;, err =&gt; {
      if (!this[kStream]) return;

      this[kStream] = null;
      this.destroy(err);
    });
  }

  /**
   * True if the session is open.
   * @return {boolean}
   */
  get isOpen() {
    return !!this[kStream];
  }

  /**
   * True if the session is no longer readable.
   * @return {boolean}
   */
  get isEnded() {
    return !this[kStream] || this[kStream].ended;
  }

  /**
   * The number of requests sent and waiting for response.
   * @return {number}
   */
  get openRequests() {
    if (!this[kRequestsMap]) return 0;

    return this[kRequestsMap].size;
  }

  /**
   * Return session constructor name.
   *
   * @override
   * @return {string}
   */
  toString() {
    return this.constructor.name;
  }

  /**
   * Convert the given value to a value that can be send ove to the other peer.
   * If the value can be send as-is, return the same value (default implementation).
   *
   * @param {*} value The value to dispatch
   * @return {*}
   */
  // eslint-disable-next-line class-methods-use-this
  dispatch(value) {
    return value;
  }

  /**
   * Send an action for execution to the other peer.
   *
   * @param {Action} action The action to send
   * @return {Session}
   */
  send(action) {
    if (!(action instanceof Action)) {
      throw new TypeError(
        `Expect first argument to be instance of Action: ${action}`,
      );
    }

    if (!this[kStream]) {
      throw new Error(`${this} already destroy`);
    }

    this[kStream].write(action);
    return this;
  }

  /**
   * Request from the other peer to fetch the given action and send back it&apos;s response value.
   *
   * @param {Action} action the given action to fetch by the peer
   * @param {object} [opts] Options
   * @param {number|null} [opts.timeout] Override the default timeout for this request (See {@link constructor}).
   * @param {function} onFulfilled a function that will be called with the response value on the
   * first arguments as-is (ie. without `Promise.resolve`).
   * @param {function} onRejected a function that will be called with an error at the first
   * argument if the fetching throws an error or the request timeout as reached.
   * @return {Session}
   */
  request(action, ...args) {
    let opts;
    let onFulfilled;
    let onRejected;

    if (args.length &lt; 3) {
      opts = {};
      onFulfilled = args[0];
      onRejected = args[1];
    } else {
      opts = args[0];
      onFulfilled = args[1];
      onRejected = args[2];

      if (typeof opts !== &apos;object&apos;) {
        throw new TypeError(`Expect &quot;options&quot; to be an object: ${typeof opts}`);
      }
    }

    if (!(action instanceof Action)) {
      throw new TypeError(
        `Expect &quot;action&quot; to be instance of Action: ${action}`,
      );
    }

    if (typeof onFulfilled !== &apos;function&apos;) {
      throw new TypeError(
        `Expect &quot;onFulfilled&quot; to be a function: ${typeof onFulfilled}`,
      );
    }

    if (typeof onRejected !== &apos;function&apos;) {
      throw new TypeError(
        `Expect &quot;onRejected&quot; to be a function: ${typeof onRejected}`,
      );
    }

    if (!this[kStream]) {
      throw new Error(`${this} already destroyed`);
    }

    if (!this[kRequestsMap] || this.isEnded) {
      throw new Error(&apos;Session already ended&apos;);
    }

    let { timeout } = opts;
    if (timeout !== undefined) {
      if (timeout !== null &amp;&amp; typeof timeout !== &apos;number&apos;) {
        throw new TypeError(`Invalid &quot;timeout&quot; option: ${timeout}`);
      }
    } else {
      timeout = this[kRequestTimeout];
    }

    let waitUntil;
    if (timeout) {
      waitUntil = Date.now() + timeout;
    } else {
      waitUntil = null;
    }

    const reqId = this.fetchRequestId();

    this[kRequestsMap].set(reqId, {
      waitUntil,
      onFulfilled,
      onRejected,
    });

    this.send(new RequestAction(reqId, action));

    if (!this[kRequestsTimer]) {
      this.requestsTimeoutInterval();
    }

    return this;
  }

  /**
   * End this session stream.
   * @return {Session}
   */
  end() {
    if (this[kStream]) {
      this[kStream].end();
    }

    return this;
  }

  /**
   * Destroy this session and it&apos;s stream.
   *
   * @emits {error} If an error given, emit and &quot;error&quot; event as well.
   * @emits {close} When the session destroyed
   * @param {Error} [err] Optional error
   * @return {undefined}
   */
  destroy(err) {
    if (this[kRequestsMap] === undefined) return;

    if (this[kStream]) {
      const stream = this[kStream];
      delete this[kStream];

      stream.destroy();
    }

    if (this[kRequestsTimer]) {
      clearTimeout(this[kRequestsTimer]);
    }

    if (this[kEndTimer]) {
      clearTimeout(this[kEndTimer]);
    }

    const requests = this[kRequestsMap];

    delete this[kRequestTimeout];
    delete this[kNextReqId];
    delete this[kRequestsMap];
    delete this[kRequestsTimer];
    delete this[kEndTimer];
    delete this[kStream];

    if (requests &amp;&amp; requests.size) {
      requests.forEach(({ onRejected }) =&gt; {
        onRejected(err || new Error(&apos;Session closed before request completed&apos;));
      });
    } else if (err) {
      this.emit(&apos;error&apos;, err);
    }

    this.emit(&apos;close&apos;);
    this.removeAllListeners();
  }

  // Actions methods

  /**
   * @ignore
   *
   * @param {number} reqId
   * @param {*|undefined} value
   * @param {*|undefined} rejected
   * @return {undefined}
   */
  response(reqId, value, rejected) {
    if (!this[kRequestsMap]) {
      throw new Error(&quot;Can&apos;t handle response, session already ended&quot;);
    }

    const req = this[kRequestsMap].get(reqId);
    if (!req) {
      throw new Error(`Response already sent: ${reqId}`);
    }

    this[kRequestsMap].delete(reqId);
    const { onFulfilled, onRejected } = req;

    if (!rejected) {
      onFulfilled(value);
    } else {
      onRejected(value);
    }
  }

  // Internal methods

  /**
   * @private
   * @return {undefined}
   */
  requestsTimeoutInterval() {
    this[kRequestsTimer] = null;
    if (!this[kRequestsMap]) return;

    const now = Date.now();
    const requests = [];
    let isDone = true;

    this[kRequestsMap].forEach(({ waitUntil }, key) =&gt; {
      if (!waitUntil) return;

      if (waitUntil &gt; now) {
        if (isDone) isDone = false;
        return;
      }

      requests.push(key);
    });

    if (requests.length) {
      process.nextTick(() =&gt; {
        requests.forEach(reqId =&gt; {
          this.response(reqId, new Error(&apos;Request timeout&apos;), true);
        });
      });
    }

    if (isDone) return;

    this[kRequestsTimer] = setTimeout(
      () =&gt; this.requestsTimeoutInterval(),
      REQUEST_TIMEOUT_INTERVAL,
    );

    if (this[kRequestsTimer].unref) this[kRequestsTimer].unref();
  }

  /**
   * @private
   * @return {number}
   */
  fetchRequestId() {
    if (!this[kRequestsMap]) {
      throw new Error(&quot;Can&apos;t fetch request id, session already ended&quot;);
    }

    let reqId;

    if (this[kRequestsMap].size &gt;= MAX_OPEN_REQUESTS) {
      throw new Error(
        `Maximum open requests number reached: ${MAX_OPEN_REQUESTS}`,
      );
    }

    do {
      reqId = this[kNextReqId];
      this[kNextReqId] += 1;

      if (this[kNextReqId] &gt;= MAX_OPEN_REQUESTS) {
        return 0;
      }
    } while (this[kRequestsMap].has(reqId));

    return reqId;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.1)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
