<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/remote-context/src/RemoteValue.js | RemoteLib</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Run remote JavaScript code as if it&apos;s your own local library."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="RemoteLib"><meta property="twitter:description" content="Run remote JavaScript code as if it&apos;s your own local library."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/remotelib/remote-lib"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#reference-context-src">reference-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/reference-context/src/reference-context.js~ReferenceContext.html">ReferenceContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isValidReference">isValidReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Reference">Reference</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-envs">remote-context/envs</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-es6UnstableEnv">es6UnstableEnv</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src">remote-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/AssignableContext.js~AssignableContext.html">AssignableContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/Context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/EnvContext.js~EnvContext.html">EnvContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalContext.js~LocalContext.html">LocalContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalPromise.js~LocalPromise.html">LocalPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalReference.js~LocalReference.html">LocalReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalSnapshot.js~LocalSnapshot.html">LocalSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteContext.js~RemoteContext.html">RemoteContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemotePromise.js~RemotePromise.html">RemotePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteSession.js~RemoteSession.html">RemoteSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteValue.js~RemoteValue.html">RemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isRemoteValue">isRemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-observe">observe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-reveal">reveal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-revoke">revoke</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Context">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EnvContext">EnvContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteContext">RemoteContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteSession">RemoteSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteValue">RemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-observe">observe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-RemoteValueProxy">RemoteValueProxy</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src-actions">remote-context/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/DeleteAction.js~DeleteAction.html">DeleteAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/GetAction.js~GetAction.html">GetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDefinePropertyAction.js~LocalDefinePropertyAction.html">LocalDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDeletePropertyAction.js~LocalDeletePropertyAction.html">LocalDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalPreventExtensionsAction.js~LocalPreventExtensionsAction.html">LocalPreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalReferenceAction.js~LocalReferenceAction.html">LocalReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalSetPrototypeOfAction.js~LocalSetPrototypeOfAction.html">LocalSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/PropertyDescriptorAction.js~PropertyDescriptorAction.html">PropertyDescriptorAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferenceAction.js~ReferenceAction.html">ReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferencePropertyAction.js~ReferencePropertyAction.html">ReferencePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectAction.js~ReflectAction.html">ReflectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectApplyAction.js~ReflectApplyAction.html">ReflectApplyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectConstructAction.js~ReflectConstructAction.html">ReflectConstructAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectGetAction.js~ReflectGetAction.html">ReflectGetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectPromiseAction.js~ReflectPromiseAction.html">ReflectPromiseAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDefinePropertyAction.js~RemoteDefinePropertyAction.html">RemoteDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDeletePropertyAction.js~RemoteDeletePropertyAction.html">RemoteDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDeletePropertyCacheAction.js~RemoteSetPropertyCacheAction.html">RemoteSetPropertyCacheAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemotePreventExtensionsAction.js~RemotePreventExtensionsAction.html">RemotePreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteReferenceAction.js~RemoteReferenceAction.html">RemoteReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetAction.js~RemoteSetAction.html">RemoteSetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetFunctionAction.js~RemoteSetFunctionAction.html">RemoteSetFunctionAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetObjectAction.js~RemoteSetObjectAction.html">RemoteSetObjectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetPropertyCacheAction.js~RemoteSetPropertyCacheAction.html">RemoteSetPropertyCacheAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetPrototypeOfAction.js~RemoteSetPrototypeOfAction.html">RemoteSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetSymbolAction.js~RemoteSetSymbolAction.html">RemoteSetSymbolAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/UndefinedValueAction.js~UndefinedValueAction.html">UndefinedValueAction</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src-helpers">remote-context/src/helpers</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cacheGetters">cacheGetters</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deleteCachedGetter">deleteCachedGetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-equalDescriptors">equalDescriptors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-equalValue">equalValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCachedGetter">getCachedGetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getOwnProperties">getOwnProperties</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getPropertyDescriptor">getPropertyDescriptor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasOwnProperty">hasOwnProperty</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isAccessorDescriptor">isAccessorDescriptor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isDataDescriptor">isDataDescriptor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-setCachedGetter">setCachedGetter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getOwnPropertyDescriptors">getOwnPropertyDescriptors</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-environment">remote-environment</a><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-es6">es6</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-instance-src">remote-instance/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-instance/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-construct">construct</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isConstructor">isConstructor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-trimArgumentsList">trimArgumentsList</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-lib-src">remote-lib/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/Library.js~Library.html">Library</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/RemoteLibrary.js~RemoteLibrary.html">RemoteLibrary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Library">Library</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RemoteLibrary">RemoteLibrary</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src">remote-protocol/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src-actions">remote-protocol/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/Action.js~Action.html">Action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/RequestAction.js~RequestAction.html">RequestAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/ResponseAction.js~ResponseAction.html">ResponseAction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/remote-context/src/RemoteValue.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Copyright 2017 Moshe Simantov
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Many methods in this file inspire from the ES5 shim for ES6 Reflect and Proxy objects:
// {@link https://github.com/tvcutsem/harmony-reflect} (Apache-2.0 License)

import EventEmitter from &apos;events&apos;;
import RemoteSession from &apos;./RemoteSession&apos;;
import RemoteContext from &apos;./RemoteContext&apos;;
import {
  LocalDefinePropertyAction,
  LocalDeletePropertyAction,
  LocalSetPrototypeOfAction,
  LocalPreventExtensionsAction,
} from &apos;./actions&apos;;
import {
  getCachedGetter,
  getPropertyDescriptor,
  isDataDescriptor,
  isAccessorDescriptor,
} from &apos;./helpers/descriptors&apos;;

const kProxyData = Symbol(&apos;proxyData&apos;);
const kError = Symbol(&apos;error&apos;);

const proxyMap = new WeakMap();

/**
 * A remote value proxy returned from the {@link RemoteValue} constructor.
 * This proxy make possible to make changes to remote values and get the changes send to
 * the remote peer.
 *
 * @typedef {object|function} RemoteValueProxy
 */

/**
 * Remote value representation locally.
 * @example
 * import { RemoteValue } from &apos;remote-context&apos;;
 *
 * const proxy = new RemoteValue(remoteSession, reference, value);
 */
export default class RemoteValue extends EventEmitter {
  /**
   * Check if the give value is a proxy of remote value.
   *
   * @param {RemoteValueProxy|*} proxy The given value
   * @return {boolean}
   */
  static isRemoteValue(proxy) {
    return proxyMap.has(proxy);
  }

  /**
   * Get the remote value instance of the given proxy.
   *
   * @param {RemoteValueProxy} proxy The given proxy
   * @throws {ReferenceError} If the given value is not a {@link RemoteValueProxy}.
   * @return {RemoteValue}
   */
  static reveal(proxy) {
    const remoteValue = proxyMap.get(proxy);

    if (!remoteValue) {
      throw new ReferenceError(
        `The given value is not a RemoteValue proxy: ${proxy}`
      );
    }

    return remoteValue;
  }

  /**
   * Resolve the given value.
   * Reject the value if it&apos;s a {@link RemoteValueProxy} and an uncaught error accord while
   * using the value (ie. assign property to the value failed). Otherwise, resolve it.
   *
   * @param {RemoteValueProxy|*} value The given value
   * @return {Promise}
   */
  static resolve(value) {
    return new Promise((resolve, reject) =&gt; {
      const remoteValue = proxyMap.get(value);
      if (!remoteValue || !remoteValue[kError]) {
        resolve(value);
        return;
      }

      const error = remoteValue[kError];
      remoteValue[kError] = null;

      reject(error);
    });
  }

  /**
   * If the given value is a {@link RemoteValueProxy}, revoke the value proxy.
   * Otherwise, do nothing.
   *
   * @param {*} proxy The given value
   * @return {void}
   */
  static revoke(proxy) {
    const remoteValue = proxyMap.get(proxy);
    if (!remoteValue) return;

    remoteValue.revoke();
  }

  /**
   * Observe for any change on the given remote value proxy.
   *
   * @see {@link https://github.com/tc39/proposal-observable}
   * @param {RemoteValueProxy} proxy The given remove value proxy
   * @param {function|null} onNext Called on every change to the given value with the
   * {@link RemoteValueProxy} as the first argument
   * @param {function|null} onError Called on every error occurred on the given value with an
   * error as first argument
   * @param {function|null} onComplete Called when the given value revoked with no arguments
   * @return {{unsubscribe: (function()), closed: boolean}} An subscription object with
   * `unsubscribe` method to stop observer events from calling and a `closed` property.
   */
  static observe(proxy, onNext = null, onError = null, onComplete = null) {
    const remoteValue = RemoteValue.reveal(proxy);

    let subscription;
    const events = {
      change: onNext &amp;&amp; (value =&gt; onNext(value)),
      error: onError,
      revoke: () =&gt; {
        subscription.closed = true;

        if (onComplete !== null) onComplete();
      },
    };

    subscription = {
      unsubscribe() {
        Object.keys(events).forEach(event =&gt; {
          const listener = events[event];
          if (!listener) return;

          remoteValue.removeListener(event, listener);
        });
      },
      closed: !remoteValue.target,
    };

    if (!subscription.closed) {
      Object.keys(events).forEach(event =&gt; {
        const listener = events[event];
        if (listener === null) return;

        remoteValue.on(event, listener);
      });
    }

    return subscription;
  }

  /**
   * Create a {@link RemoteValue} class and a proxy to the given value.
   *
   * @param {RemoteSession} session The current value remote session
   * @param {Reference} reference he value reference for further updates to the remote peer
   * @param {*} value The given value
   * @return {RemoteValueProxy} A proxy to the given value
   */
  constructor(session, reference, value) {
    if (!(session instanceof RemoteSession)) {
      throw new TypeError(
        `Expect session to be instance of RemoteSession: ${session}`
      );
    }
    if (!RemoteContext.isValidReference(reference)) {
      throw new TypeError(`The given reference is not valid: ${reference}`);
    }

    if (!(value instanceof Object)) {
      return value;
    }

    super();

    const self = this;
    this[kError] = null;

    this[kProxyData] = Proxy.revocable(value, {
      get(target, property) {
        const desc = getPropertyDescriptor(target, property);
        if (desc === undefined) return undefined;

        let val;
        if (isDataDescriptor(desc)) {
          val = desc.value;
        } else {
          const getter = desc.get;
          if (getter === undefined) {
            return undefined;
          }

          return getCachedGetter(target, property);
        }

        if (typeof val !== &apos;function&apos; || !session.exists(val)) {
          return val;
        }

        const remoteContext = session.remote;
        if (!remoteContext.exists(val)) {
          return val;
        }

        return remoteContext.fetch(remoteContext.lookup(val));
      },

      set(target, property, val, receiver) {
        let desc = getPropertyDescriptor(target, property);
        if (desc === undefined) {
          desc = {
            value: undefined,
            writable: true,
            enumerable: true,
            configurable: true,
          };
        }

        if (isAccessorDescriptor(desc)) {
          const setter = desc.set;
          if (setter === undefined) return false;

          const ret = setter.call(receiver, val); // assumes Function.prototype.call

          if (RemoteValue.isRemoteValue(setter)) {
            ret.then(() =&gt; {});
          }

          return true;
        }

        if (desc.writable === false) return false;

        const existingDesc = Object.getOwnPropertyDescriptor(
          receiver,
          property
        );

        if (existingDesc) {
          Object.defineProperty(receiver, property, {
            value: val,
            writable: existingDesc.writable,
            enumerable: existingDesc.enumerable,
            configurable: existingDesc.configurable,
          });
          return true;
        }

        if (!Object.isExtensible(receiver)) return false;

        Object.defineProperty(receiver, property, {
          value: val,
          writable: true,
          enumerable: true,
          configurable: true,
        });
        return true;
      },

      setPrototypeOf(target, prototype) {
        session.request(
          LocalSetPrototypeOfAction.fromRemote(session, reference, prototype),
          () =&gt; {},
          err =&gt; self.reject(err)
        );

        return true;
      },

      preventExtensions() {
        session.request(
          LocalPreventExtensionsAction.fromRemote(session, reference),
          () =&gt; {},
          err =&gt; self.reject(err)
        );

        return true;
      },

      defineProperty(target, property, descriptor) {
        session.request(
          LocalDefinePropertyAction.fromRemote(
            session,
            reference,
            property,
            descriptor
          ),
          () =&gt; {},
          err =&gt; self.reject(err)
        );

        return true;
      },

      deleteProperty(target, property) {
        session.request(
          LocalDeletePropertyAction.fromRemote(session, reference, property),
          () =&gt; {},
          err =&gt; self.reject(err)
        );

        return true;
      },
    });

    this[kProxyData].target = value;
    const { proxy } = this[kProxyData];

    proxyMap.set(proxy, this);
    return proxy;
  }

  get proxy() {
    return this[kProxyData].proxy;
  }

  get target() {
    return this[kProxyData].target;
  }

  reject(error) {
    if (!this[kError]) {
      this[kError] = error;
    }

    try {
      this.emit(&apos;error&apos;, error);
    } catch (err) {
      // Ignore throwing error if no listeners found
    }
  }

  revoke() {
    delete this[kProxyData].target;
    this[kProxyData].revoke();

    this.emit(&apos;revoke&apos;);
  }

  // Update methods

  setPrototypeOf(prototype) {
    const { target, proxy } = this[kProxyData];
    if (!target) return false;

    Object.setPrototypeOf(target, prototype);
    this.emit(&apos;change&apos;, proxy, &apos;setPrototypeOf&apos;);

    return true;
  }

  preventExtensions() {
    const { target, proxy } = this[kProxyData];
    if (!target) return false;

    Object.preventExtensions(target);
    this.emit(&apos;change&apos;, proxy, &apos;preventExtensions&apos;);

    return true;
  }

  defineProperty(property, descriptor) {
    const { target, proxy } = this[kProxyData];
    if (!target) return false;

    Object.defineProperty(target, property, descriptor);
    this.emit(&apos;change&apos;, proxy, &apos;defineProperty&apos;, property);

    return true;
  }

  deleteProperty(property) {
    const { target, proxy } = this[kProxyData];
    if (!target) return false;

    Object.deleteProperty(target, property);
    this.emit(&apos;change&apos;, proxy, &apos;deleteProperty&apos;, property);

    return true;
  }
}

/**
 * @type {RemoteValue.isRemoteValue}
 */
export const isRemoteValue = RemoteValue.isRemoteValue;

/**
 * @type {RemoteValue.reveal}
 */
export const reveal = RemoteValue.reveal;

/**
 * @type {RemoteValue.revoke}
 */
export const revoke = RemoteValue.revoke;

/**
 * @type {RemoteValue.observe}
 */
export const observe = RemoteValue.observe;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
