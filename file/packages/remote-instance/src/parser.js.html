<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">packages/remote-instance/src/parser.js | Remotelib</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Run code remotely"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Remotelib"><meta property="twitter:description" content="Run code remotely"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/remotelib/remote-lib"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#reference-context-src">reference-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/reference-context/src/reference-context.js~ReferenceContext.html">ReferenceContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isValidReference">isValidReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Reference">Reference</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src">remote-context/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/AssignableContext.js~AssignableContext.html">AssignableContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/Context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/EnvContext.js~EnvContext.html">EnvContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalContext.js~LocalContext.html">LocalContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalPromise.js~LocalPromise.html">LocalPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/LocalReference.js~LocalReference.html">LocalReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/ObjectSnapshot.js~ObjectSnapshot.html">ObjectSnapshot</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteContext.js~RemoteContext.html">RemoteContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemotePromise.js~RemotePromise.html">RemotePromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteSession.js~RemoteSession.html">RemoteSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/RemoteValue.js~RemoteValue.html">RemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getInstance">getInstance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isRemoteValue">isRemoteValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-observe">observe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-reveal">reveal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-revoke">revoke</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-context-src-actions">remote-context/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/DeleteAction.js~DeleteAction.html">DeleteAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/GetAction.js~GetAction.html">GetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDefinePropertyAction.js~LocalDefinePropertyAction.html">LocalDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalDeletePropertyAction.js~LocalDeletePropertyAction.html">LocalDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalPreventExtensionsAction.js~LocalPreventExtensionsAction.html">LocalPreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalReferenceAction.js~LocalReferenceAction.html">LocalReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/LocalSetPrototypeOfAction.js~LocalSetPrototypeOfAction.html">LocalSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/PropertyDescriptorAction.js~PropertyDescriptorAction.html">PropertyDescriptorAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/PropertyDescriptorsAction.js~PropertyDescriptorsAction.html">PropertyDescriptorsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferenceAction.js~ReferenceAction.html">ReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReferencePropertyAction.js~ReferencePropertyAction.html">ReferencePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectAction.js~ReflectAction.html">ReflectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectApplyAction.js~ReflectApplyAction.html">ReflectApplyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectConstructAction.js~ReflectConstructAction.html">ReflectConstructAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectGetAction.js~ReflectGetAction.html">ReflectGetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/ReflectPromiseAction.js~ReflectPromiseAction.html">ReflectPromiseAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDefinePropertyAction.js~RemoteDefinePropertyAction.html">RemoteDefinePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteDeletePropertyAction.js~RemoteDeletePropertyAction.html">RemoteDeletePropertyAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemotePreventExtensionsAction.js~RemotePreventExtensionsAction.html">RemotePreventExtensionsAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteReferenceAction.js~RemoteReferenceAction.html">RemoteReferenceAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetAction.js~RemoteSetAction.html">RemoteSetAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetFunctionAction.js~RemoteSetFunctionAction.html">RemoteSetFunctionAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetObjectAction.js~RemoteSetObjectAction.html">RemoteSetObjectAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetPrototypeOfAction.js~RemoteSetPrototypeOfAction.html">RemoteSetPrototypeOfAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/RemoteSetSymbolAction.js~RemoteSetSymbolAction.html">RemoteSetSymbolAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-context/src/actions/UndefinedValueAction.js~UndefinedValueAction.html">UndefinedValueAction</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-instance-src">remote-instance/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-instance/src/parser.js~Parser.html">Parser</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-lib-src">remote-lib/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/Context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-lib/src/Library.js~Library.html">Library</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src">remote-protocol/src</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#remote-protocol-src-actions">remote-protocol/src/actions</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/Action.js~Action.html">Action</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/RequestAction.js~RequestAction.html">RequestAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/packages/remote-protocol/src/actions/ResponseAction.js~ResponseAction.html">ResponseAction</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">packages/remote-instance/src/parser.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Copyright 2017 Moshe Simantov
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import bl from &apos;bl&apos;;
import deepEqual from &apos;deep-equal&apos;;
import msgPack5 from &apos;msgpack5&apos;;
import duplexify from &apos;duplexify&apos;;

const TYPE_CODE_MIN = 0x01;
const TYPE_CODE_MAX = 0xff;
const kParser = Symbol(&apos;parser&apos;);

export default class Parser {
  /**
   * Check if the given value is a remote-instance constructor.
   * An remote-instance constructor is a constructor with a method `toArgumentsList()`
   * that enable to get the construct arguments of this class to create it remotely.
   *
   * @param {function} constructor the given value to check
   * @return {boolean} True if it&apos;s a remote-instance constructor
   */
  static isConstructor(constructor) {
    return (
      typeof constructor === &apos;function&apos; &amp;&amp;
      constructor.prototype != null &amp;&amp;
      typeof constructor.prototype.toArgumentsList === &apos;function&apos;
    );
  }

  /**
   * Construct a new instance of the given constructor with the given arguments list.
   * If the constructor has a static method `fromArgumentsList(argumentsList)` this
   * function will use that function to construct the instance.
   *
   * @param {function} constructor The given constructor
   * @param {Array} [argumentsList] The given arguments list that will apply an the new operator.
   * @return {*} A new instance of the given constructor
   */
  static construct(constructor, argumentsList = []) {
    if (typeof constructor.fromArgumentsList === &apos;function&apos;) {
      return constructor.fromArgumentsList(argumentsList);
    }

    return new constructor(...argumentsList);
  }

  /**
   * Trim a given argument list to a shorter list by removing undefined or default values.
   * Default arguments comparing via strict deep-equal comparison.
   * For example, for the given argument list: `[1, &apos;foo&apos;, undefined, {}]` and the given
   * default: `[undefined, &apos;foo&apos;, &apos;bar&apos;, {}]`. The trimmed arguments list will be: `[1]`.
   *
   * @param {Array} argumentsList The given argument list
   * @param {Array} [defaults] The default arguments for this argument list.
   * @return {Array}
   */
  static trimArgumentsList(argumentsList, defaults = []) {
    let trimIndex = argumentsList.length;
    const opts = { strict: true };

    while (trimIndex &gt; 0) {
      const index = trimIndex - 1;
      const arg = argumentsList[index];

      if (arg !== undefined &amp;&amp; !deepEqual(arg, defaults[index], opts)) {
        break;
      }

      trimIndex = index;
    }

    return Array.prototype.slice.call(argumentsList, 0, trimIndex);
  }

  /**
   * Create an instance of remote-instance Parser.
   *
   * @param {object} [opts] The given options for the parser
   * @param {object} [opts.parser] An alternative `msgpack5` parser
   * instance
   */
  constructor(opts = {}) {
    this[kParser] = opts.parser || msgPack5();
  }

  /**
   * Register an instance on the parser with given type-code and constructor.
   * The type-code value must be consistent in all the remote devices for the given constructor.
   * The first argument could be also an object-map of type-codes and constructors instead.
   *
   * @param {number|object} typeCode The numeric type-code for this instance between `0x01` to
   * `0xff`.
   * @param {function} [constructor] A remote-instance constructor
   * @return {Parser}
   */
  register(typeCode, constructor) {
    if (
      typeof typeCode === &apos;object&apos; &amp;&amp;
      Object.getPrototypeOf(typeCode) === Object.prototype
    ) {
      Object.keys(typeCode).forEach(key =&gt; {
        this.register(Number(key), typeCode[key]);
      });
      return this;
    }

    if (
      !Number.isInteger(typeCode) ||
      typeCode &lt; TYPE_CODE_MIN ||
      typeCode &gt; TYPE_CODE_MAX
    ) {
      throw new TypeError(
        `Expect typeCode to be integer between ${TYPE_CODE_MIN}-${TYPE_CODE_MAX}: ${typeCode}`,
      );
    }

    if (!this.constructor.isConstructor(constructor)) {
      throw new TypeError(
        `Expect constructor to have &quot;toArgumentsList&quot; method: ${constructor}`,
      );
    }

    this[kParser].register(
      typeCode,
      constructor,
      expr =&gt; this.encodeArgumentsList(expr.toArgumentsList()),
      buffer =&gt;
        this.constructor.construct(
          constructor,
          this.decodeArgumentsList(buffer),
        ),
    );

    return this;
  }

  /**
   * Decode a given arguments list buffer.
   *
   * @param {Buffer|BufferList} buffer an encoded arguments list buffer
   * @return {Array} The decoded arguments list
   */
  decodeArgumentsList(buffer = bl()) {
    const bufferList = buffer instanceof bl ? buffer : bl().append(buffer);
    const argumentsList = [];

    while (bufferList.length) {
      argumentsList.push(this.decode(bufferList));
    }

    return argumentsList;
  }

  /**
   * Encode a given arguments list to a buffer.
   *
   * @param {Array} argumentsList The given arguments list
   * @return {BufferList} The encoded arguments list
   */
  encodeArgumentsList(argumentsList = []) {
    const bufferList = bl();

    // Trim undefined arguments
    let maxIndex = argumentsList.length - 1;
    while (maxIndex &gt;= 0 &amp;&amp; argumentsList[maxIndex] === undefined) {
      maxIndex -= 1;
    }

    // Encode only the necessary values
    for (let i = 0; i &lt;= maxIndex; i += 1) {
      const buffer = this.encode(argumentsList[i]);
      bufferList.append(buffer);
    }

    return bufferList;
  }

  /**
   * Encode an value or an instance to a buffer.
   *
   * @param {*} value Any value or registered instance
   * @return {BufferList} The encoded buffer
   */
  encode(value) {
    return this[kParser].encode(value);
  }

  /**
   * Decode an value or an instance from an encoded buffer.
   *
   * @param {Buffer|BufferList} buffer The encoded buffer
   * @return {*} Any value or registered instance
   */
  decode(buffer) {
    return this[kParser].decode(buffer);
  }

  /**
   * Get an transform stream that convert objects to buffer.
   *
   * @return {Stream}
   */
  encoder() {
    return this[kParser].encoder();
  }

  /**
   * Get an transform stream that convert buffer to objects.
   *
   * @return {Stream}
   */
  decoder() {
    return this[kParser].decoder();
  }

  /**
   * Create a duplex stream that transform duplex buffer stream to object stream.
   *
   * @param {Stream} stream A duplex buffer stream
   * @param {object} [opts] An options object to construct the duplex stream with.
   *    The option `objectMode` is forced to be true.
   * @return {Stream} A duplex object stream
   */
  transform(stream, opts = {}) {
    const duplexReadable = this.decoder();
    const duplexWritable = this.encoder();

    stream.pipe(duplexReadable);
    duplexWritable.pipe(stream);

    const objectStream = duplexify(
      duplexWritable,
      duplexReadable,
      Object.assign(opts, {
        objectMode: true,
      }),
    );

    stream.on(&apos;error&apos;, err =&gt; objectStream.destroy(err));
    objectStream.on(&apos;close&apos;, () =&gt; stream.destroy());
    stream.on(&apos;close&apos;, () =&gt; objectStream.destroy());

    return objectStream;
  }
}

const { isConstructor, construct, trimArgumentsList } = Parser;
export { isConstructor, construct, trimArgumentsList };
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.1)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
